#include "xc.inc"
GLOBAL _multi_signed
PSECT mytext, local, class=CODE, reloc=1
 
LOAD_BYTE MACRO DES, LITERAL
	MOVLW LITERAL
	MOVWF DES
ENDM
	

    

MUL_8X4: ; temporary register: 0x9X, IN: TRISA, TRISB; OUT 0X90, 0X91
    CLRF 0X90
    CLRF 0X91
    LOAD_BYTE 0X99, 0XFE ; MASK
    LAYER1:
	BTFSS TRISB, 0
	    GOTO LAYER2
	NOP
	MOVF TRISA, 0
	MOVFF TRISA, 0X91
    LAYER2:
	RLNCF TRISA
	BTFSS TRISB, 1
	    GOTO LAYER3
	NOP
	MOVF TRISA, 0
	ADDWF 0X91
	BTFSC STATUS, 0
	    INCF 0X90
	NOP
	BCF STATUS, 0
    LAYER3:
	RLNCF TRISA	
	BTFSS TRISB, 2
	    GOTO LAYER4
	NOP
	MOVF 0X99, 0
	ANDWF TRISA, 0
	ADDWF 0X91
	COMF 0X99, 0
	ANDWF TRISA, 0
	ADDWFC 0X90
	BCF STATUS, 0
	BCF 0X99, 1
    LAYER4:
        RLNCF TRISA
	BTFSS TRISB, 3
	    GOTO RET
	NOP
	MOVF 0X99, 0
	ANDWF TRISA, 0
	ADDWF 0X91
	COMF 0X99, 0
	ANDWF TRISA, 0
	ADDWFC 0X90
	BCF STATUS, 0
	BCF 0X99, 2
    RET:
	RETURN
    
_multi_signed:
    MOVFF 0X01, 0X02
    MOVWF 0X01
    LOAD_BYTE 0X89, 0X00
    SETF WREG
    BTFSC 0X01, 7
	XORWF 0X89
    NOP
    BTFSC 0X01, 7
	NEGF 0X01
    NOP
    BTFSC 0X02, 7
	XORWF 0X89
    NOP
    BTFSC 0X02, 7
	NEGF 0X02
    NOP
    MOVFF 0X01, TRISA
    MOVFF 0X02, TRISB
    RCALL MUL_8X4
    MOVFF 0X91, 0X01
    MOVFF 0X90, 0X02
    TSTFSZ 0X89
	GOTO NEG
    NOP
    RETURN
    
    NEG:
    COMF 0X01
    COMF 0X02
    INCF 0X01
    BTFSC STATUS, 0
	INCF 0X02
    NOP
    RETURN
END


